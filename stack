#!/usr/bin/env sh
STACK_PATH=$(pwd)

set -ae

source "$STACK_PATH/.env.dist"
if [ -f "$STACK_PATH/.env" ]; then
    source "$STACK_PATH/.env"
fi

if [ "path" = $1 ]; then
    echo $STACK_PATH
    exit
fi

CONTAINER_BIN=
if command -v docker > /dev/null 2>&1; then
    CONTAINER_BIN=docker
elif command -v podman > /dev/null 2>&1; then
    CONTAINER_BIN=podman
else
    echo "Could not find neither \"docker\" nor \"podman\", aborting"

    exit 1
fi

CONTAINER_COMPOSE=
if command -v docker-compose > /dev/null 2>&1; then
    CONTAINER_COMPOSE=docker-compose
elif command -v podman-compose > /dev/null 2>&1; then
    CONTAINER_COMPOSE=podman-compose
else
    echo "Could not find neither \"docker-compose\" nor \"podman-compose\", aborting"

    exit 1
fi

if [ "ps" = $1 ] || [ "ls" = $1 ]; then
    $CONTAINER_BIN ps | grep opencodeco
    exit
fi

if [ "network" = $1 ]; then
    NET=$($CONTAINER_BIN network ls | grep opencodeco)

    if [ -z "$NET" ]; then
        echo "OpenCodeCo network not found. Creating one..."
        $CONTAINER_BIN network create opencodeco
        echo "🕸️ Done!"
    else
        echo "🕸️ OpenCodeCo network already exists!"
    fi

    exit
fi

COMPONENT=$STACK_PATH/$1

if [ ! -d $COMPONENT ]; then
    echo "\033[0;31mWhoops! Component \"$COMPONENT\" does not exists." >&2
    exit 1
fi

CMD=${@:2}
$CONTAINER_COMPOSE -f $COMPONENT/docker-compose.yml ${CMD:-up -d}
